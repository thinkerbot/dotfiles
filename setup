#!/bin/bash
#############################################################################
DOTFILES_HOME="${1:-$HOME/.dotfiles}"

if ! [ -e "$DOTFILES_HOME" ]
then
  printf "error: dotfiles dir does not exist: %s" "$DOTFILES_HOME"
  exit 1
fi

# The complicated code ensures that REPOS_HOME is, in order:
# * provided by the user
# * the existing symlink
# * dotfiles/repos
CURRENT_REPOS_HOME="$(ls -l "$DOTFILES_HOME" | grep 'repos ->' | awk '{print $NF}')"
REPOS_HOME="${2:-${CURRENT_REPOS_HOME:-$DOTFILES_HOME/repos}}"
REPOS_DIR="$DOTFILES_HOME/repos"

#############################################################################
# Installs the dotfiles.  Execute and then source .bash_profile

install () {
  grep -v DOTFILES_HOME "$1" > "$1.tmp" 2>/dev/null
  cat - "$1.tmp" > "$1"
  rm "$1.tmp"
}

install ~/.bash_profile <<DOC
export DOTFILES_HOME="$DOTFILES_HOME"
source "\$DOTFILES_HOME/files/bash_profile"
DOC

install ~/.vimrc <<"DOC"
source $DOTFILES_HOME/files/vimrc
DOC

#############################################################################
# Setup git
if which -s git 
then git config --global color.ui true
fi

#############################################################################
# Setup scripts 
git_clone () {
  if ! [ -d "$(basename "$1" ".git")" ]
  then git clone "$1"
  fi
}

if [ -e "$REPOS_DIR" ] && [ x"$REPOS_HOME" != x"$REPOS_DIR" ] && ! rm "$REPOS_DIR"
then
  printf "Manually remove the repos dir and try again.\n"
  exit 1
fi

mkdir -p "$REPOS_HOME"
if ! [ -e "$REPOS_DIR" ]
then ln -s "$REPOS_HOME" "$REPOS_DIR"
fi
cd "$REPOS_HOME"

# ln -s ../repos/3454779/slice bin/slice

git_clone git://gist.github.com/2638925.git
git_clone git://gist.github.com/3454779.git
git_clone git://github.com/thinkerbot/ts.git
git_clone git://github.com/thinkerbot/series.git

cd - >/dev/null

